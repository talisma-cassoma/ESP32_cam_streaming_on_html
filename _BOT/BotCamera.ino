/*
INTELLCAP_BOT
IBIN TOFAIL UNIVERSITY - KENITRA
"data:image/jpeg;base64,%2F9j%2F4AAQSkZJRgABAQEAAAAAAAD%2F2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL%2F2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL%2FxAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv%2FxAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5%2Bjp6vHy8%2FT19vf4%2Bfr%2FxAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv%2FxAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4%2BTl5ufo6ery8%2FT19vf4%2Bfr%2FwAARCAB4AKADASEAAhEBAxEB%2F9oADAMBAAIRAxEAPwCRIYs%2F6uP%2FAL5qwkMX%2FPKP%2FvkUcq7HJyospDH%2FAM8o%2FwDvmrKwx%2F8APKP%2FAL5FTyxLsWEhj%2F55J%2F3zVlIY%2FwDnlH%2F3wKXLEdiYQRf88o%2F%2B%2BBUogi%2F55R%2F98Clyx7DsO8iL%2FnjH%2FwB8Cg28X%2FPKP%2FvgU%2BVDsRG3j%2F55R%2F8AfApvkR%2F88o%2F%2B%2BBRZBYjaKL%2FnlH%2F3wKhaKL%2FnlH%2F3wKfKhWK7xRf88o%2F%2B%2BBVOf7PCm%2BRYVX1KiqsgsZFzq1nHxFAJT7JgVmT6ncS5CxwRKfSMZp2RLiZrwhzllVj7rSCzDdIV%2FwC%2Baoix1EEu%2FwCU%2Feq8lSUWUqylIsspVpKQywoqQCkMfil20gGMtRMKAKdxNFDzJIif7x61j3GuQKP3KNKf%2B%2BRVCMmfVLybOCsY%2FwBgVmSKztuclm9WOTVICMxU3yR60xC7UXoOaiku4U6uM%2B3NMk1ehyKvWs2%2Fg%2FepSAvLVlKkotxmrSVIyylTrSGPpruka7ndUX1Y4pDMq4123RW8pWlYf8BFc5deLYZXCjUrSPdxiOQZqrAVQyXDM6yCRv4iDmkMdUhEbKKryMq%2BgoApy3AHQZqo80x%2B6NtWSQskkg%2Bdiab5OKZLOnxSYx0qQNK2n8wYP3qvIakssxmraNUjJ%2FNWNNzsEX%2B8xxVeXWoY%2BI8yt7cCpApy6vdSjCbYh7DJrmfEviOHRIBNPuuLyXKxKxq4oZ5jq3iXUtZbZNKfL7QxcLVSG0upvuxH8eKvYqxdSy1GxXz4C6erQsQa0bXxhqMMifaH%2B0Rjghhg1JLR1NjqcerQb4G6feXHIqU2%2FrQSM8jFRtFTAj2VEwpks6DGKSmCFHyEEda0I7uPy9zuFx1qBj%2F7WhH%2BrVpP%2FHRTTqV0%2FwBwiMewqSiMcndIxZvVjk07zQo4oAkg3PuJ%2FCvINbu59f1%2BZ8nykYqnP3UzQmMfBYRxex9TU5u7e2bbks3oKe5Zp2F0twNnkuCfWm3HhlJmZo3KHOSrUXCRzaSXelXiyL5sDjkZ7ivQ9Ivf7S0yOf8A5afdf61RBZZahK0EkJFQstMRu0lDENNV5vvipGOSSp1kpFEgcnoKeEkNSMu6fDs8xvWvNNQtYdO1G8jiXGZ5Dj0G7pQikZNzJ5kZCnmspmMT4H3verQ2zs4tOitYIHh1VJJnTdJEmUeDiti3vlmG1l%2Bb1HepAwvEWnzSyLJGu9MY4yTUXhS%2BGntcm5aWOzK53%2BUzLuqvIlnQW%2FiHS7%2B4MVpc%2BaQu4ny2UCrzihEkLCoWFMk357d4G5%2B72NQ0CGmoph8lBRHHDVuKGpYy6kQqcJUjFln%2BwaVd3QTeYUZ1T%2B8ccCvGvOnl1AvK7TXMz%2FMx7saEVHc6WHQ7ZrbJH7w%2FxZrG1DQjayks5%2FKndmjiR21sycjmtzT2O7Yw6UwLHiZpIvDVxJAzLINvzKcHG4VxWlXyQQy7pPcU0ZMtW%2BvSN9lhnlhbL7F4WPyVJFd%2FDn7LFuOTsFGhLAiomWmSdrLDxwNy91rNurHYpki%2BZO49KBFGo5OwpFj41q5GlSBaValxxUjJ1hWazaNujqRXkzaWnh%2B9nF5Ngbf3kzICVbcwpoaM%2B71K7mtofsEgwW%2B8GxWuk93f6XFBqBiklhPyXC%2FeKn%2BGg23K9t%2B7uNm6ultNL%2B0ASY2AfxUrlxpubsjcsl8mdfsuTInzeYTjYPWvLvH%2BrWWseKpLqzhdG8pI7mRwV8%2BUceZTp6%2B8bYpQhFQiGiT%2FANmS2t5ZXDpP%2FwAs8Ptblq9Abk1bPPZHimEUEnc4qBkwdyYB7%2B9DApXFkJAXiG1%2B6%2BtY7A%2BcQR04pXAsxJVuNakZYC1JjipGW4hiMV5p4ltPtGpaik2WRpmP%2FfJOKaLicp%2B5th5a8AVZF1f2y7hp1x5ecZMZAz2qyzZ0ixj1h4r%2B%2FtDbLE2VCyY86uqkuweMhQFztHXFYvVno0UqVPmkVvOa5KpjYndQao654Ss9Zu1uv9XJt2uUH3q0joebUm5y5mN8M2b6FJqFsl9l4%2F8AR2xGo3I0aPWoRvPyKzn%2FAGRmqMrgttcv9y3b8eKlXSLtjy0Sr%2BJNMR1rCoj1oJQ3HzDiufJ8%2BVpcY3HOPSpGWI1q0gpDJxT6kZbX7grgNV8uSe58wPGiX5heRvQuOaLjRwHzw399DBBDIFZolknU%2FuhkgNV1p2nuvtN7cSXU%2FTfKfuj0rQ0j3Oh0xbSZNzxLn1xzUMMHla3czxHP2hhkD2HSoKlc37Zd0rHp2rRhbsTVmR2VrbWi65LD9ltLWPWtDWQOqBQJI2w7Vnajptxp101vchd%2F3gVbIK%2BtAivHFmrMVv2xQSWJhVanIgqX0wS2l6dNmD71lRCpKLairKrSGSgU6pGWqydftIbjTpPNcR78qOM72I24oEeW2emeVaahDKjrMr4b5MdKxmfy3qkamlbXzsmEPSr2lXIF2C3J7Ux3OnhuI1XdnrzUkdxvkqiDsVuY4fDmi6%2FHHF5uk34S9cg58h8xvXXeKLEGSO9Kh0x5UgPbqRWcdxHORWvzkK2Vzw23GRWtBp7cdea0M2Y0zVXoYkZOqn%2FVx9ydxqCEVBRbSrAoZQ8VJ3FSAv2jzLg21riWYEB%2F7sWa0bTTFt5jcErLd9PtEgzhf7tIDn%2FGugMbaTU7fJ4%2Ff%2F414rq%2BxWVV%2B8OtVApGbFcvEeDWla3jZzmtLAaw1N34FbWm3m513cUh9D0rwY0OoWWq6Td5a3uIvmj9UYFHrrfBt0%2BqeE%2F7P1Jt99YE6fe%2B7p%2FFUrcktW%2BhOsh3FQua14rSOMDviqFynldjfLfwCQdasnpSZmYF7J5uoP6J8gp8dAy0lT1JQ4U9eXFIZfU%2FOvtWgr%2FLQImVldCjDKsMEHuK8T%2BIngSXRnOo2kiSafNJtCk%2FvIzjpTi7MZ5w8RjPzLUsZOK0KNa0lCpWnYXH72kM6611e700%2FabKYRXAQqrldw5FaHw9%2BI91%2FwAJZnWTa41TbbSyRrsImTOw0iUe7xTxThjFKj7Ttbac4PpT6ZR5FZ6ULKdzHwrGrrLtBJ6KMmhnOcvHlmLHqeTV2MUiiyoqSpKHCpIv9YKQFxW%2BYVZD%2FLQA%2FwC1R28fmzSLHGP4mOK4T4g%2BL9OvPD11pFsGkkl8s%2BeflC4kU0IDxuZstVcEg1qaF2N%2FkrT06TncTUsC5f64tvBsTlzVDwzBZ6lfXUF6%2Fl70%2BWQdUOfvU%2BhJ6TYX%2FwDa2mRWN9%2B61SJ%2FJuAveVeK3dK8U6noRW2M0rW0fy7WGQKLkao6byuaz9b%2FAHGlykZy5EYP86DI5uJatp0pGhMtOzSGNkmSFcuwWub1LxYYIx9mCrIwLLv9iM0FE%2Bm%2BK%2F8ARUuJUaXqR5YbheQKqXnii9eeRftEsTJjCWmcc0i5QsYWoa212xCzySTfd3M253rk9XWa3by3c%2BZ96QZ4z2FXFkGaxzzUZamWKJDVhLkxpxTAqu5c5NWNOSb7SksR8tgfldumaTEdLq%2BoMdTF9KzD7QqpIYz3A%2BRqbN4t1i0uFF5NLfCLIXzZm%2Bc0IjlTP%2F%2FZ"
this board[ESP32-CAM] is responsable for send bot image to firebase 
*/

#include <IOXhop_FirebaseESP32.h>  //running <arduinoJson.h> version 5.13.5    
#include "soc/soc.h"
#include "soc/rtc_cntl_reg.h"
#include "Base64.h"
#include <ESP32Servo.h>


#define WIFI_SSID     "********"                    
#define WIFI_PASSWORD "********"         
#define FIREBASE_HOST "********"    
#define FIREBASE_AUTH "********"   



#define IN1_PIN 12 //dc motors pin controls
#define IN2_PIN 13
//#define IN3_PIN 14 //electric cylinder pin controls
//#define IN4_PIN 15

#define SERVO_1 14

Servo servoN1;
Servo servoN2;
Servo servo1;

int angleDegree = 0; 
 
#include "esp_camera.h"

// WARNING!!! Make sure that you have either selected ESP32 Wrover Module,
//            or another board which has PSRAM enabled

//CAMERA_MODEL_AI_THINKER
#define PWDN_GPIO_NUM     32
#define RESET_GPIO_NUM    -1
#define XCLK_GPIO_NUM      0
#define SIOD_GPIO_NUM     26
#define SIOC_GPIO_NUM     27

#define Y9_GPIO_NUM       35
#define Y8_GPIO_NUM       34
#define Y7_GPIO_NUM       39
#define Y6_GPIO_NUM       36
#define Y5_GPIO_NUM       21
#define Y4_GPIO_NUM       19
#define Y3_GPIO_NUM       18
#define Y2_GPIO_NUM        5
#define VSYNC_GPIO_NUM    25
#define HREF_GPIO_NUM     23
#define PCLK_GPIO_NUM     22


String Photo2Base64(){
    camera_fb_t * fb = NULL;
    fb = esp_camera_fb_get();  
    if(!fb) {
      Serial.println("Camera capture failed");
      return "";
    }
  
    String imageFile = "data:image/jpeg;base64,";
    char *input = (char *)fb->buf;
    char output[base64_enc_len(3)];
    for (int i=0;i<fb->len;i++) {
      base64_encode(output, (input++), 3);
      if (i%3==0) imageFile += urlencode(String(output));
    }

    esp_camera_fb_return(fb);
    
    return imageFile;
}

//https://github.com/zenmanenergy/ESP8266-Arduino-Examples/
String urlencode(String str)
{
    String encodedString="";
    char c;
    char code0;
    char code1;
    char code2;
    for (int i =0; i < str.length(); i++){
      c=str.charAt(i);
      if (c == ' '){
        encodedString+= '+';
      } else if (isalnum(c)){
        encodedString+=c;
      } else{
        code1=(c & 0xf)+'0';
        if ((c & 0xf) >9){
            code1=(c & 0xf) - 10 + 'A';
        }
        c=(c>>4)&0xf;
        code0=c+'0';
        if (c > 9){
            code0=c - 10 + 'A';
        }
        code2='\0';
        encodedString+='%';
        encodedString+=code0;
        encodedString+=code1;
        //encodedString+=code2;
      }
      yield();
    }
    return encodedString;
}

void setup()
{
  WRITE_PERI_REG(RTC_CNTL_BROWN_OUT_REG, 0); //disable brownout detector
  
  servo1.setPeriodHertz(50);    // standard 50 hz servo
  
  servoN1.attach(2, 1000, 2000);
  servoN2.attach(13, 1000, 2000);
  
  servo1.attach(SERVO_1, 1000, 2000);
  
  servo1.write(angleDegree);

  Serial.begin(115200);
  delay(10);

pinMode(IN1_PIN, OUTPUT);
pinMode(IN2_PIN, OUTPUT);
//pinMode(IN3_PIN, OUTPUT);
//pinMode(IN4_PIN, OUTPUT);

  camera_config_t config;
  config.ledc_channel = LEDC_CHANNEL_0;
  config.ledc_timer = LEDC_TIMER_0;
  config.pin_d0 = Y2_GPIO_NUM;
  config.pin_d1 = Y3_GPIO_NUM;
  config.pin_d2 = Y4_GPIO_NUM;
  config.pin_d3 = Y5_GPIO_NUM;
  config.pin_d4 = Y6_GPIO_NUM;
  config.pin_d5 = Y7_GPIO_NUM;
  config.pin_d6 = Y8_GPIO_NUM;
  config.pin_d7 = Y9_GPIO_NUM;
  config.pin_xclk = XCLK_GPIO_NUM;
  config.pin_pclk = PCLK_GPIO_NUM;
  config.pin_vsync = VSYNC_GPIO_NUM;
  config.pin_href = HREF_GPIO_NUM;
  config.pin_sscb_sda = SIOD_GPIO_NUM;
  config.pin_sscb_scl = SIOC_GPIO_NUM;
  config.pin_pwdn = PWDN_GPIO_NUM;
  config.pin_reset = RESET_GPIO_NUM;
  config.xclk_freq_hz = 20000000;
  config.pixel_format = PIXFORMAT_JPEG;
  //init with high specs to pre-allocate larger buffers
  if(psramFound()){
    config.frame_size = FRAMESIZE_QQVGA;
    config.jpeg_quality = 8;  //0-63 lower number means higher quality
    config.fb_count = 2;
  } else {
    config.frame_size = FRAMESIZE_QQVGA;/*(Quarter Quarter VGA) A screen resolution of 160x120 pixels, 
    which is one fourth the total number of pixels in the QVGA standard (320x240)*/
    config.jpeg_quality = 8;  //0-63 lower number means higher quality
    config.fb_count = 1;
  }
  
  // camera init
  esp_err_t err = esp_camera_init(&config);
  if (err != ESP_OK) {
    Serial.printf("Camera init failed with error 0x%x", err);
    delay(1000);
    ESP.restart();
  }

  //drop down frame size for higher initial frame rate
  sensor_t * s = esp_camera_sensor_get();
  s->set_framesize(s, FRAMESIZE_QQVGA);  // UXGA|SXGA|XGA|SVGA|VGA|CIF|QVGA|HQVGA|QQVGA

  //WIFI
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  Serial.print(":) Conectando ao wifi");
  
  while (WiFi.status() != WL_CONNECTED)
  {
    Serial.print(".");
    delay(100);
  }
  
  Serial.println();
 
 //conectando ao firebase 
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
  
  //firebase stream listem all changes in real time
  /*Firebase.stream("/controls", [](FirebaseStream stream) {
    ... WE SET ARDUINO BOARD FOR CARE THIS PART ...
  });*/
}
 
void loop()
{
   Firebase.setString("/imageCaptured/base64Image", Photo2Base64());
}